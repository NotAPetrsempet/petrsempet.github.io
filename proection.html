<!DOCTYPE html>

<html lang="ru" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Mercedes-Benz Assistant</title>
    <script>
    var max = -1;
    var coords = "";
	    var last_coords = "";
	    var max_coords = 0;
	    var points = [];
	    var last_speed = 0;
	    var start_time = 0;
	    var razgon = false;
    var obl = "";
	    var kml = "";
	    var odometr = 0;
	    var stop_time = 0;
	    var count = 0;
	    var weather = "";
	    function getWeather(){
	    	var xhr = new XMLHttpRequest();
		    xhr.open('GET', 'https://openweathermap.org/data/2.5/weather?lat='+coords.latitude+'&lon='+coords.longitude+'&appid=439d4b804bc8187953eb36d2a8c26a02');
		    xhr.onload = function(){weather =  JSON.parse(xhr.responseText);}
		    xhr.send();
		    return xhr;
	    }
    function getObl(lat, lon){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://nominatim.openstreetmap.org/reverse?format=json&lat='+lat+'&lon='+lon+'&zoom=18&addressdetails=1');
        xhr.onload = function(){
              var json = JSON.parse(xhr.responseText);
              var new_obl = json.address.state;
              console.log(new_obl);
              var np = json.address;
              if (new_obl != obl){
                    new_oblast(new_obl);
			  }
              obl = new_obl;
		}
        xhr.send();
    }
	    var n_count = 0;
	    var n_timer = 0;
	    var e_count = 0;
	    var s_count = 0;
    function data(position){
	    count++;
        if (position != null){
            coords = position.coords;
        }else{
            position.coords = coords;
        }
        speed.innerHTML = (position.coords.speed * 3.6)+" км/ч"; 
        azimut.style.transform = 'rotate('+position.coords.heading+'deg)'; 
        console.log(position);
	    if (position.coords.heading == 0 & n_count == 0){
	    	speak('Север');
		    n_count = 1;
		    if (n_count == 1){
		    	n_timer = setTimeout(function(){n_count = 0;}, 90000);
		    }
	    }
	    	    if (position.coords.heading == 90 & e_count == 0){
	    	speak('Восток');
		    e_count = 1;
		    if (e_count == 1){
		    	setTimeout(function(){e_count = 0;}, 90000);
		    }
	    }	    	    if (position.coords.heading == 180 & s_count == 0){
	    	speak('Юг');
		    s_count = 1;
		    if (s_count == 1){
		    	setTimeout(function(){s_count = 0;}, 90000);
		    }
	    }	    	    if (position.coords.heading == 270 & e_count == 0){
	    	speak('Запад');
		    w_count = 1;
		    if (w_count == 1){
		    	setTimeout(function(){w_count = 0;}, 90000);
		    }
	    }
	    if ((position.coords.speed * 3.6) < 60){
	    	speed.style.color = 'green';
		    if (zone > 1){
		    	zone = 1;
			    var audio = new Audio('down.m4a');
			    audio.play();
		    }
	    }
	    	    if ((position.coords.speed * 3.6) < 90 & (position.coords.speed * 3.6) > 59){
	    	speed.style.color = 'yellow';
		    if (zone > 2){
		    	zone = 2;
			    var audio = new Audio('down.m4a');
			    audio.play();
		    }
			    		    if (zone < 2){
		    	zone = 2;
			    var audio = new Audio('up.m4a');
			    audio.play();
		    }
	    }
	    	    	    if ((position.coords.speed * 3.6) < 110 & (position.coords.speed * 3.6) > 89){
	    	speed.style.color = 'orange';
		    if (zone > 3){
		    	zone = 3;
			    var audio = new Audio('down.m4a');
			    audio.play();
		    }
			    		    if (zone < 3){
		    	zone = 3;
			    var audio = new Audio('up.m4a');
                            audio.onended = function(){speak('Режим — трасса!');};
			    audio.play();
		    }
	    }
	    	    	    if ((position.coords.speed * 3.6) > 109){
	    	speed.style.color = 'red';
			    		    if (zone < 4){
		    	zone = 4;
			    var audio = new Audio('up.m4a');
						    audio.onended = function(){speak('Внимание! Вы находитесь в красной зоне!');}
			    audio.play();
		    }
	    }
	    if (!night){
	    	speed.style.color = 'white';
	    }
    }
			    var zone = 1;
	    var w_count = 0;
    function speak(text, isWarning){
     var synth = new Audio('https://tts.voicetech.yandex.net/generate?format=mp3&lang=ru-RU&key=c6e36647-5bf5-46fd-9262-7820f4a867e5&emotion=good&speaker=tanya&speed=1&text='+text);
     synth.onloadeddata = function(){
     if (isWarning){
        var audio = new Audio('warning.wav');
        audio.onended = function(){synth.play();};
        audio.play();
	 }else{
      synth.play();
	 }
     };
     
     synth.load();
	}
    function new_oblast(oblast){
     var synth = new Audio('https://tts.voicetech.yandex.net/generate?format=mp3&lang=ru-RU&key=c6e36647-5bf5-46fd-9262-7820f4a867e5&emotion=good&speaker=ermil&speed=1&text=Добро пожаловать! Это — '+oblast);
          synth.onloadeddata = function(){
        var audio = new Audio('new_oblast.mp3');
        audio.onended = function(){synth.play();};
        audio.play();
     };
     
     synth.load();
    
	}
	    var last_speed = 0;
	    var razgon = 0;
	    var night = false;
    function start(){

        document.head.requestFullscreen();
        navigator.geolocation.getCurrentPosition(function(position){var lat = position.coords.latitude; var lon = position.coords.longitude;         var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://nominatim.openstreetmap.org/reverse?format=json&lat='+lat+'&lon='+lon+'&zoom=18&addressdetails=1');
        xhr.onload = function(){
              var json = JSON.parse(xhr.responseText);
              var new_obl = json.address.state;
              obl = new_obl;
			var msg = "Здравствуйте!"; var date = new Date(); if (date.getHours() < 12){msg = "Доброе утро!";}else if (date.getHours() < 17& date.getHours() > 11){msg = "Добрый день!";}else if (date.getHours() > 16){msg = "Добрый вечер!";} speak(msg+' Система готова к работе. связь установлена! Ваш регион — '+obl+'! Будьте бдительны, не забывайте о правилах дорожного движения, ведь они созданы для вашей безопасности. Желаем вам, счастливой поездки! Для завершения два раза нажмите на компас!', true);
						if (getWeather().weather.icon.indexOf('n') != -1){
					night = true;
				}else{
					night = false;
				}	
		setInterval(function(){
				if (getWeather().weather.icon.indexOf('n') != -1){
					if ((getWeather().weather.icon.indexOf('n') != -1) != night){
						speak('Ночной режим');
					}
					night = true;
				}else{
					night = false;
					if ((getWeather().weather.icon.indexOf('n') != -1) != night){
						speak('Дневной режим');
					}
				}
			}, 60000);
        setInterval(function(){if (coords != ""){getObl(coords.latitude, coords.longitude)}}, 10000);
		setInterval(function(){if (last_coords.latitude != coords.latitude || last_coords.longitude != coords.longitude){if (coords.altitude == null){kml += coords.latitude+", "+coords.longitude+", 0";}else{kml += coords.latitude+", "+coords.longitude+", "+coords.altitude;}kml += "\n"; last_coords = coords;}}, 5000);
		};

							    xhr.send();			           start_btn.style.display = 'none';
        main.style.display = 'block';
								   }, function(err){speak('Произошла ошибка! Проверьте своё соединение и наличие разрешения на использование GPS');
		

        
        },{enableHighAccuracy: true, timeout: 1000, maximumAge: 0});
        setInterval(function(){navigator.geolocation.getCurrentPosition(data, function(err){console.warn(err);},{enableHighAccuracy: true, timeout: 1000, maximumAge: 1000});}, 50);
    }
    </script>
</head>
<body style="background: black; color: white; font-family: Arial; transform: scale(1, -1);">
    <center>
        <h1 style="font-size: 70px;" onclick="start()" id="start_btn">СТАРТ</h1>
        <div style="display: none;" id="main">
            <h1 style="font-size: 50px;" id="speed">0 км/ч</h1>
            <br></br>
            <img id="azimut" ondoubleclick="end()" src="compass.png" width="300" height="300">
        </div>
    </center>
</body>
</html>
